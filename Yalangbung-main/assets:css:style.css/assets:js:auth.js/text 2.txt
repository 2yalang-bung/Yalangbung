const products = [
  { id: 1, name: "T-Shirt", category: "Clothing", price: 19.99, stripeLink: "https://buy.stripe.com/test_ABC111" },
  { id: 2, name: "Smartphone", category: "Electronics", price: 299.99, stripeLink: "https://buy.stripe.com/test_DEF222" },
  { id: 3, name: "Book - JavaScript 101", category: "Books", price: 14.99, stripeLink: "https://buy.stripe.com/test_GHI333" },
  { id: 4, name: "Jeans", category: "Clothing", price: 39.99, stripeLink: "https://buy.stripe.com/test_JKL444" },
  { id: 5, name: "Laptop", category: "Electronics", price: 899.99, stripeLink: "https://buy.stripe.com/test_MNO555" }
];

function loadProducts(filtered = products) {
  const container = document.getElementById("product-list");
  if (!container) return;
  container.innerHTML = "";
  filtered.forEach(product => {
    const div = document.createElement("div");
    div.className = "product";
    div.innerHTML = `
      <h3>${product.name}</h3>
      <p>Category: ${product.category}</p>
      <p>$${product.price.toFixed(2)}</p>
      <button onclick="addToCart(${product.id})">Add to Cart</button>
      <a href="${product.stripeLink}" target="_blank"><button>Buy Now</button></a>
    `;
    container.appendChild(div);
  });
}

function getCart() {
  const user = localStorage.getItem("currentUser");
  return JSON.parse(localStorage.getItem(`cart_${user}`) || "[]");
}

function saveCart(cart) {
  const user = localStorage.getItem("currentUser");
  localStorage.setItem(`cart_${user}`, JSON.stringify(cart));
}

function updateCartCount() {
  const cart = getCart();
  const count = cart.length;
  const el = document.getElementById("cart-count");
  if (el) el.textContent = count;
}

function addToCart(id) {
  const cart = getCart();
  cart.push(id);
  saveCart(cart);
  updateCartCount();
}

function viewCart() {
  toggleSections("cart-section");
  const cart = getCart();
  const list = document.getElementById("cart-items");
  list.innerHTML = "";
  cart.forEach((id, index) => {
    const product = products.find(p => p.id === id);
    const item = document.createElement("li");
    item.textContent = `${product.name} - $${product.price.toFixed(2)} `;
    const removeBtn = document.createElement("button");
    removeBtn.textContent = "Remove";
    removeBtn.onclick = () => {
      cart.splice(index, 1);
      saveCart(cart);
      viewCart();
      updateCartCount();
    };
    item.appendChild(removeBtn);
    list.appendChild(item);
  });
}

function checkout() {
  toggleSections("checkout-form");
}

function submitOrder(event) {
  event.preventDefault();
  saveCart([]);
  updateCartCount();
  toggleSections("order-confirmation");
}

function toggleSections(showId) {
  ["product-list", "cart-section", "checkout-form", "order-confirmation"]
    .forEach(id => document.getElementById(id)?.classList.add("hidden"));
  document.getElementById(showId)?.classList.remove("hidden");
}

function applyFilters() {
  const search = document.getElementById("search-box").value.toLowerCase();
  const category = document.getElementById("category-filter").value;
  const minPrice = parseFloat(document.getElementById("min-price").value) || 0;
  const maxPrice = parseFloat(document.getElementById("max-price").value) || Infinity;

  const filtered = products.filter(p =>
    p.name.toLowerCase().includes(search) &&
    (category === "all" || p.category === category) &&
    p.price >= minPrice &&
    p.price <= maxPrice
  );

  loadProducts(filtered);
}
